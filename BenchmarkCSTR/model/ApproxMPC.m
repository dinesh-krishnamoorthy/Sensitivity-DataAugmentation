function [Y,Xf,Af] = ApproxMPC(X,~,~)
%APPROXCTRLLAW_FINAL neural network simulation function.
%
% Auto-generated by MATLAB, 01-Jun-2020 13:18:44.
% 
% [Y] = ApproxCtrlLaw_final(X,~,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 4xQ matrix, input #1 at timestep ts.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 1xQ matrix, output #1 at timestep ts.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1.keep = [1 2];
x1_step2.xoffset = [0.0527;0.52561052631579];
x1_step2.gain = [4.75059382422803;5.93842787935615];
x1_step2.ymin = -1;

% Layer 1
b1 = [-2.5363441600790004316;-3.4542723884214230345;-4.3989246288597279033;-0.29182538536961288855;1.1566532946989136477;0.32409087633604283241;1.7689062965904087665;1.8016616693259102089;-1.3232279255636456572;4.5583964496872235728];
IW1_1 = [2.6575531776750334068 4.2837435884432659705;-0.030474999904531636236 -6.4705617496943155231;4.1775305890928864372 -2.2035814442467813734;2.0221923348429147183 -3.2746550176227331441;-0.30001447048460649913 3.8421269933260946416;-1.6631562347816151171 -1.9055227668716143707;2.6090752048061807145 -0.12629614757660917457;2.469659850485836472 -2.9706052761246377614;0.85183068095139102827 5.4646491169843631752;3.8231269979263244885 0.88155702880733544102];

% Layer 2
b2 = [-1.6031946277012516511;-1.4556083141227382782;1.1968266403132012954;0.74013408792086488042;-0.65581215622353095096;-0.17415873188144620487;-0.0043889236271544831633;1.4933122340040652087;1.6552611559262488949;2.878720493470376951];
LW2_1 = [0.21004739814144884891 2.1093615798427349795 -1.5490318696959937128 -0.71288529796611188605 -1.5368973008400457214 -1.0116325969751325253 0.18468959230309756059 0.30282001930345459062 0.25161076855815017739 -0.45915471190310747085;1.8050162810019820814 -0.56163168854116529705 0.39558842618963013793 -2.9495793325483732339 -0.8521013636461892693 0.18192499073183615588 0.50534646344358880032 0.24293630716046840656 0.89563263156359385064 1.5723432933297776248;-0.29848590467213931277 0.18939549201956046298 0.16177712140521355311 0.42633531888539283328 0.45089203138866346121 -1.19629749842753208 -0.88258775584343984733 0.53284500356234976159 -0.67999537728829262395 0.19131817378153542775;-0.49000473143168948864 -0.87903704123118120428 0.00032616063351505880652 -0.26016836564786621766 0.050998822629212139934 -0.83115258863549612567 0.65409527610411766219 0.26836810157899315676 0.40468532022744085896 -0.083733049137940177009;1.5820149102007436959 0.063201951002770276333 0.92914879520382842593 -0.36147776821889499033 0.18638083626461113274 -0.67671128096631338877 -0.81263636271596273453 -0.057606533522470609876 0.11914913624232373324 -0.97647740216120715306;0.78362209641570623742 -0.9118463561218376201 -0.18725465717700107149 -0.4344625350405617592 -0.046778874458611369169 -0.0099612891403714955846 0.77014441000667999138 -0.67119500594405923088 0.96907592815238152717 0.34791059040051880435;-0.63815170166843837585 1.5084250522958455587 0.056602400158274973618 -0.78729537414295780451 0.91249860890804035396 -1.8183792292508431654 0.59155054805999751633 0.045950151464618470276 1.4266925701542916283 -0.46322407410423244167;-0.15871411679759422908 -0.49726969949836641316 0.40235792605761117047 -0.060494310237006430897 0.57837481143518298943 -0.01547996514415924188 -0.47753851644481504213 0.85604660512259411753 0.50391925754052802056 0.78701978693913909879;0.23049542715518597791 -3.2035148072557873 1.4177848886557604668 0.3918929446175591913 0.56965097697473410232 0.17190167805091044473 0.028637071293971323033 0.4230053951456324568 0.76566803119337334405 0.16998395149036976681;0.65190360083684195658 0.34460512121382941286 -0.41684816042399791547 -0.41192354720048890426 -1.6779167813585651459 0.94980676476195236013 -0.47577993008944780007 -0.64750533742184224195 1.890896271142971985 1.3229500445167459155];

% Layer 3
b3 = [-1.740041544431328413;-1.2963705818150459415;1.1608486579948757988;0.57205589982666005255;-0.65398736920080235979;0.10550916834521505139;-0.14691042381607943845;-0.55933234936820752647;-1.6247005216396406269;-1.6639523537673455156];
LW3_2 = [0.96944606788485399029 -0.51022668144274685442 -0.16418770582571634575 -0.62337791904406303356 0.48859019812459647536 -0.3629681756645409263 0.18841769444654826726 -0.078881711127915615789 0.42832114406702709308 -0.95547265416941906668;0.50527645147954247662 0.31595372248832437334 -0.040961651482140364056 -0.067814814928586319986 -0.11216453530567771502 1.3233173753477716073 -0.60036880953115767667 0.65728395926854987774 -0.56874306651483808039 -1.2792797427656354969;-0.42427405942831480923 -0.72537483865674701189 0.081062497748563860922 -0.3332518392011270536 -0.7944884030325349844 -0.34553082838577175995 -0.93207612674466111535 0.4752218447181494887 0.8480539023152521283 -0.5459929600861276322;-0.4074971405760667853 -0.66557639992619188618 -0.53612215517654071562 -0.15508637354033719125 0.396851487506667433 -1.4062584702255755964 2.4819479499636427633 0.22370141830687240159 -0.94135071759686705928 1.1897474174431590388;0.70221128887195960466 -0.30165517696377341927 0.18469492242877413868 -0.8159913154927987966 -0.71954457542975236439 1.6417956564664195618 0.71675992400759358514 -0.48393352710061077193 0.076854009751237059578 -1.3854063126048437038;-0.32080609255742642549 0.67587061808361126314 0.011551494284989183986 0.71104012228997115486 0.23997556036433081994 0.12850400671185854828 0.68180954805437510302 -1.3319758016855409721 0.54306716204892657718 -0.79869458396238568465;-1.0030876415318490391 -2.6756199084818685918 0.32381441133580429748 0.066307373392166329973 -0.89285301262598115724 -0.54023609771325709072 -1.5203797818871291891 0.60272003942139928956 0.86585075176736892022 -0.94991752418537966918;-0.7020174310757837377 -1.4244060339271993332 -0.13587422222004849615 -0.21435131336184132245 -0.26597181715852713513 -0.10157559242920721765 0.89601079374225711671 -0.55064114856022305933 -1.3320237709738766974 0.69326212021650235329;-0.83445465702763654825 0.1265140261244273312 -0.12384893727359966298 -0.65170362319748864621 0.2487069355901104506 1.8757578769466758395 1.6615092657564956014 0.80555789772213848288 0.10396978434195294771 -1.7089867426347420398;-1.1753805533292562835 0.2867552212588361793 1.0470082415338954895 -0.032301678567810743203 -0.15142520216537472266 1.1634261326619927956 0.8053726442247346462 0.41146362928521779123 0.89755235380085807151 -0.29572918671180309369];

% Layer 4
b4 = 1.1459888615736755213;
LW4_3 = [0.12883466962808212686 0.93295071618111213851 0.2399472305128985683 -0.5102063640188816418 -1.3616717533021545083 0.3213490337571938138 0.15374380715758387272 0.49835015591848424998 0.7111782669083585029 0.81724541274498818666];

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX
  X = {X};
end

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
  Q = size(X{1},2); % samples/series
else
  Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS

    % Input 1
    temp = removeconstantrows_apply(X{1,ts},x1_step1);
    Xp1 = mapminmax_apply(temp,x1_step2);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = tansig_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Layer 3
    a3 = tansig_apply(repmat(b3,1,Q) + LW3_2*a2);
    
    % Layer 4
    a4 = repmat(b4,1,Q) + LW4_3*a3;
    
    % Output 1
    Y{1,ts} = a4;
end

% Final Delay States
Xf = cell(1,0);
Af = cell(4,0);

% Format Output Arguments
if ~isCellX
  Y = cell2mat(Y);
end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings)
  y = bsxfun(@minus,x,settings.xoffset);
  y = bsxfun(@times,y,settings.gain);
  y = bsxfun(@plus,y,settings.ymin);
end

% Remove Constants Input Processing Function
function y = removeconstantrows_apply(x,settings)
  y = x(settings.keep,:);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n,~)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end
